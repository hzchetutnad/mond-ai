<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>–ú–æ–Ω–¥–µ–π | AI-–î–∏–∞–ª–æ–≥–∏</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root {
      --bg: #0f0f0f;
      --accent: #8774e1;
      --user-bg: #2b5278;
      --bot-bg: #1f3926;
      --text: #e1e3e6;
      --system-bg: #2d2d2d;
      --input-height: 60px;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      padding-bottom: calc(var(--input-height) + 20px);
      scroll-behavior: smooth;
      -webkit-overflow-scrolling: touch;
    }

    .message {
      max-width: 75%;
      margin: 8px 0;
      padding: 12px 16px;
      border-radius: 18px;
      animation: fadeIn 0.3s ease;
    }

    .user {
      background: var(--user-bg);
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .bot {
      background: var(--bot-bg);
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .message.system {
      background: var(--system-bg);
      margin: 12px auto;
      text-align: center;
      padding: 8px 16px;
      width: fit-content;
    }

    .system button {
      background: none;
      border: none;
      color: var(--accent);
      padding: 6px 12px;
      cursor: pointer;
      font: inherit;
    }

    .message.error {
      background: #3a1d1d;
      border: 1px solid #ff4444;
    }

    .message.error button {
      background: none;
      border: none;
      color: #ff8888;
      text-decoration: underline;
      cursor: pointer;
      padding: 0;
      margin-left: 8px;
    }

    #input-area {
      position: sticky;
      bottom: 0;
      background: var(--bg);
      border-top: 1px solid #2d2d2d;
      padding: 12px;
      display: flex;
      gap: 8px;
      min-height: var(--input-height);
    }

    #message {
      flex: 1;
      padding: 10px 16px;
      border: none;
      border-radius: 24px;
      background: #1c1c1c;
      color: var(--text);
      outline: none;
    }

    #send {
      background: var(--accent);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      cursor: pointer;
    }

    .typing {
      display: inline-block;
      padding: 8px 16px;
      background: var(--bot-bg);
      border-radius: 18px;
      font-style: italic;
      opacity: 0.8;
    }

    #counter {
      text-align: center;
      padding: 8px;
      font-size: 0.9em;
      color: #888;
    }

    #reset-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    #reset-modal.visible {
      display: flex;
      animation: fadeIn 0.2s ease;
    }

    .modal-box {
      background: var(--bg);
      padding: 24px;
      border-radius: 14px;
      width: 80%;
      max-width: 300px;
      text-align: center;
    }

    .modal-buttons {
      margin-top: 20px;
      display: flex;
      gap: 12px;
      justify-content: center;
    }

    .modal-buttons button {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: var(--system-bg);
      color: var(--text);
      cursor: pointer;
      transition: 0.2s;
    }

    .modal-buttons button:first-child {
      background: var(--accent);
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
  </style>
</head>
<body>
  <div id="chat"></div>
  <div id="counter"></div>
  <div id="input-area">
    <input type="text" id="message" placeholder="–ù–∞–ø–∏—à–∏ —á—Ç–æ-–Ω–∏–±—É–¥—å...">
    <button id="send">‚û§</button>
  </div>

  <div id="reset-modal" class="hidden">
    <div class="modal-box">
      <p>–¢–æ—á–Ω–æ —Ö–æ—á–µ—à—å —Å—Ç–µ—Ä–µ—Ç—å –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é?</p>
      <div class="modal-buttons">
        <button onclick="confirmReset(true)">–î–∞</button>
        <button onclick="confirmReset(false)">–ù–µ—Ç</button>
      </div>
    </div>
  </div>

  <script>
    if (!window.Telegram?.WebApp?.initDataUnsafe?.user?.id) {
      document.body.innerHTML = `<div style="padding:20px;text-align:center">
        <h2>üö´ –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞</h2>
        <p>–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç–æ—Ç WebApp —á–µ—Ä–µ–∑ Telegram</p>
      </div>`;
      throw new Error("Invalid launch environment");
    }

    const API = "";
    const tg = window.Telegram.WebApp;
    let messageCount = 0;
    const MAX_FREE = 5;
    let lastMessageText = '';
    let isHistoryLoaded = false;

    tg.expand();
    tg.MainButton.setText("–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ú–æ–Ω–¥–µ–π");
    tg.MainButton.color = "#8774e1";

    const chat = document.getElementById('chat');
    const messageInput = document.getElementById('message');
    const sendBtn = document.getElementById('send');
    const counter = document.getElementById('counter');

    sendBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', e => e.key === 'Enter' && sendMessage());

    async function init() {
      try {
        const historyResponse = await fetch(`${API}/history?userId=${tg.initDataUnsafe.user.id}`);
        const { history } = await historyResponse.json();

        if (history.length > 0) {
          history.forEach(msg => {
            if (msg.role === 'user') {
              addUserMessage(msg.content, true);
            } else {
              addBotMessage(msg.content, true);
            }
          });
          isHistoryLoaded = true;
        }
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', error);
      }

      if (!isHistoryLoaded) {
        initSystemMessage();
        addBotMessage(`<b>${tg.initDataUnsafe.user.first_name}</b>, —è –ú–æ–Ω–¥–µ–π. –¢—ã –º–æ–∂–µ—à—å —Å–ø—Ä–æ—Å–∏—Ç—å —á—Ç–æ —É–≥–æ–¥–Ω–æ, –Ω–æ —Ç–æ–ª—å–∫–æ ${MAX_FREE} —Ä–∞–∑.`);
      }

      scrollToBottom();

      const usageData = await fetch(`${API}/usage?userId=${tg.initDataUnsafe.user.id}`).then(res => res.json());
      messageCount = usageData.used;
      updateCounter();
    }

    init();

    function initSystemMessage() {
      const systemMsg = document.createElement('div');
      systemMsg.className = 'message system';
      systemMsg.innerHTML = `<button onclick="openResetModal()">üîÅ –ù–∞—á–∞—Ç—å —Å–Ω–∞—á–∞–ª–∞</button>`;
      chat.prepend(systemMsg);
    }

    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text || (messageCount >= MAX_FREE && !tg.MainButton.isVisible)) return;

      lastMessageText = text;
      addUserMessage(text);
      messageInput.value = '';
      showTyping();

      try {
        const response = await fetch(`${API}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: {
              text: text,
              from: { id: tg.initDataUnsafe.user.id }
            }
          })
        });

        const data = await response.json();
        messageCount = data.used || messageCount + 1;

        if (data.isLimitReached) {
          tg.MainButton.show();
          messageInput.disabled = true;
        }

        hideTyping();
        addBotMessage(data.message);
        updateCounter();
        lastMessageText = '';

      } catch (error) {
        hideTyping();
        addErrorMessage();
      }
    }

    function addErrorMessage() {
      chat.innerHTML += `
        <div class="message bot error">
          ‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–≤—è–∑–∏. <button onclick="retryLast()">‚Üª –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
        </div>
      `;
      scrollToBottom();
    }

    async function retryLast() {
      if (!lastMessageText) return;

      const errorMessages = chat.getElementsByClassName('error');
      while (errorMessages.length > 0) {
        errorMessages[0].remove();
      }

      showTyping();

      try {
        const response = await fetch(`${API}/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: {
              text: lastMessageText,
              from: { id: tg.initDataUnsafe.user.id }
            }
          })
        });

        const data = await response.json();
        messageCount = data.used || messageCount;

        if (data.isLimitReached) {
          tg.MainButton.show();
          messageInput.disabled = true;
        }

        hideTyping();
        addBotMessage(data.message);
        updateCounter();
        lastMessageText = '';

      } catch (error) {
        hideTyping();
        addErrorMessage();
      }
    }

    async function performReset() {
      try {
        const response = await fetch(`${API}/reset-history`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId: tg.initDataUnsafe.user.id })
        });

        if (response.ok) {
          chat.innerHTML = '';
          initSystemMessage();
          addBotMessage('–ò—Å—Ç–æ—Ä–∏—è —Å–±—Ä–æ—à–µ–Ω–∞. –ì–æ—Ç–æ–≤ –∫ –Ω–æ–≤–æ–π –¥—Ä–∞–º–µ.');
          const usageData = await fetch(`${API}/usage?userId=${tg.initDataUnsafe.user.id}`).then(res => res.json());
          messageCount = usageData.used;
          updateCounter();
        }
      } catch (error) {
        addBotMessage('üî• –ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫ –ø—Ä–∏ —Å–±—Ä–æ—Å–µ');
      }
    }

    function confirmReset(confirmed) {
      document.getElementById('reset-modal').classList.remove('visible');
      if (confirmed) performReset();
    }

    function openResetModal() {
      document.getElementById('reset-modal').classList.add('visible');
    }

    function addUserMessage(text, fromHistory = false) {
      if (!fromHistory) {
        chat.querySelector('.system')?.remove();
      }
      chat.innerHTML += `<div class="message user">${escapeHtml(text)}</div>`;
      scrollToBottom();
    }

    function addBotMessage(text) {
      chat.innerHTML += `<div class="message bot">${text}</div>`;
      scrollToBottom();
    }

    function showTyping() {
      chat.innerHTML += `<div class="typing">–ú–æ–Ω–¥–µ–π –¥—É–º–∞–µ—Ç...</div>`;
      scrollToBottom();
    }

    function hideTyping() {
      const typing = chat.querySelector('.typing');
      if (typing) typing.remove();
    }

    function updateCounter() {
      const remaining = MAX_FREE - messageCount;
      counter.textContent = remaining > 0 
        ? `–û—Å—Ç–∞–ª–æ—Å—å ${remaining} –∏–∑ ${MAX_FREE} —Å–æ–æ–±—â–µ–Ω–∏–π`
        : '–õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω!';
    }

    function scrollToBottom() {
      setTimeout(() => chat.scrollTo(0, chat.scrollHeight), 50);
    }

    function escapeHtml(text) {
      return text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    tg.MainButton.onClick(() => {
      fetch(`${API}/subscribe`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userId: tg.initDataUnsafe.user.id })
      }).then(() => {
        tg.MainButton.hide();
        messageInput.disabled = false;
        messageCount = 0;
        updateCounter();
      });
    });
  </script>
</body>
</html>
